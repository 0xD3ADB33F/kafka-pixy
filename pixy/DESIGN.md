## Consumer

Outlines how the SmartConsumer implementation breaks down to actors and
goroutines.

By **actor** we mean an instance of a struct that has at least one associated
goroutine. When it is said that actor `A` supervises actor `B`, that means that
actor `A` may start actor `B` while running and it is guaranteed that when
actor `A` is stopped it makes sure to stop actor `B`.

### SmartConsumer

Implements:

 * `dispatchTierFactory` - it is used by the supervised `dispatcher` to create 
   `consumerGroup` instances when they are needed. 

Supervises:

 * `dispatcher` (actor) - dispatches `consumeRequest`s generated by the `Consume`
   method to respective `groupConsumer` actors creating them on demand. If a
   particular `groupConsumer` actor has not been used for
   `Config.Consumer.RegistrationTimeout` time then it is stopped;
 * `sarama.OffsetManager` (actor) - created just so it can be used by the
   downstream tier actors to create `sarama.PartitionOffsetManager`s;
 * `sarama.Consumer` (actor) - created just so it can be used by the downstream
   tier actors to create `sarama.PartitionConsumer`s;

### groupConsumer

Implements:

 * `dispatchTierFactory` - it is used by the supervised `dispatcher` to create
   `topicConsumer` instances when they are needed.
 * `dispatchTier` - so that `SmartConsumer.dispatcher` can dispatch requests to
   `groupConsumer` instances.

Supervises:

 * `dispatcher` (actor) - dispatches `consumeRequest`s coming from the upstream
   `SmartConsumer.dispatcher` to respective `topicConsumer` actors creating
   them on demand. If a particular `topicConsumer` actor has not been used for
   `Config.Consumer.RegistrationTimeout` time then it is stopped;
 * `consumerGroupRegistry` (actor) - registers this SmartConsumer instance as a
   member of the specified consumer group in ZooKeeper. When a `topicConsumer`
   is started or stopped it updates the topic subscription in the ZooKeeper.
   It watches for membership and subscription changes for the group in the
   ZooKeeper. When any such change happens the `managePartitions`
   goroutine is notified.
 * `managePartitions` (goroutine) - listens for group membership and topic 
   subscription changes and runs partition rebalancing for all affected topics,
   creating `exclusiveConsumer` actors for partitions that this member got
   ownership over, and stopping `exclusiveConsumer` actors for partitions that
   no longer belong to this member.

### topicConsumer

Implements:

 * `dispatchTier` - so that `groupConsumer.dispatcher` can dispatch requests to
   `topicConsumer` instances. 

Supervises:

 * `run` (goroutine) - receives `consumeRequest`s and then tries to read a
   message from its message channel that is been feed by respective
   `exclusiveConsumers` if a message is not received within
   `Config.Consumer.LongPollingTimeout` then a timeout error is send to the
   `consumeRequest`s reply channel.

### exclusiveConsumer

Supervises:

 * `run` (goroutine) claims the partition in the ZooKeeper to ensure that the
   partition is consumed by no other group member and creates
   `sarama.PartitionConsumer` actor to pull messages from the Kafka partition
   and feeds them to the associated `topicConsumer` message channel. It also
   creates `sarama.PartitionOffsetManager` actor to commit consumed message
   offsets.
